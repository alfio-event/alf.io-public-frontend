<div *ngIf="reservationInfo && event">

  <app-stepper [currentStep]="3" [free]="reservationInfo.orderSummary.free"></app-stepper>

  <app-countdown [validity]="reservationInfo.validity" (expired)="handleExpired($event)"></app-countdown>

  <form [formGroup]="overviewForm" (submit)="confirm()">


    <div class="page-header">
      <h2 translate="reservation-page.title"></h2>
    </div>

    <div class="row">
      <div class="col-12" [ngClass]="{'col-md-8': event.invoicingConfiguration.invoiceAllowed}">
        <app-summary-table [event]="event" [reservationInfo]="reservationInfo"></app-summary-table>
      </div>
      <div class="d-none d-md-flex col-md-1 justify-content-md-center" *ngIf="event.invoicingConfiguration.invoiceAllowed">
        <div class="border-left separator"></div>
      </div>

      <div class="col-12 col-md-3 invoice-details text-center" *ngIf="event.invoicingConfiguration.invoiceAllowed">
        <div class="d-flex flex-column justify-content-between h-100">
          <h5 class="d-none d-md-block" translate="reservation-page.invoice-details"></h5>
          <div class="page-header d-block d-md-none" translate="reservation-page.invoice-details"></div>
          <div class="d-flex justify-content-center">
            <address *ngIf="reservationInfo.invoiceRequested" class="text-left">
              <div class="preformatted">{{reservationInfo.billingAddress}}</div>
              <div *ngIf="hasTaxId">{{'invoice.vat' |translate: {'0': ('common.vat' | translate)} }} {{reservationInfo.billingDetails.taxId}}</div>
              <hr *ngIf="enabledItalyEInvoicing"/>
              <h5 class="d-none d-md-block" *ngIf="enabledItalyEInvoicing" translate="invoice-fields.addresseeItalyEInvoice"></h5>
              <div *ngIf="enabledItalyEInvoicing">{{'invoice-fields.fiscalCode'|translate}}{{': '}}{{italyEInvoicingFiscalCode}}</div>
              <div *ngIf="enabledItalyEInvoicing && italyEInvoicingReference != null">
                {{(italyEInvoicingSelectedAddresseeKey | translate) + ': ' + italyEInvoicingReference}}
              </div>
            </address>
            <div *ngIf="!reservationInfo.invoiceRequested">
              <div ><fa-icon class="text-muted" [icon]="['fas', 'file-invoice']" size="2x"></fa-icon></div>
              <div class="mt-2" translate="reservation-page.no-invoice-requested"></div>
            </div>
          </div>
          <div class="mt-2">
            <button type="button" class="btn btn-secondary" (click)="back(true)"><fa-icon [icon]="['far', 'edit']"></fa-icon>{{' '}}{{(reservationInfo.invoiceRequested ? 'common.edit' : 'reservation-page.request-invoice') | translate}}</button>
          </div>
        </div>
      </div>
    </div>


    <div class="alert alert-danger" role="alert" *ngIf="globalErrors && globalErrors.length > 0">
      <div *ngFor="let err of globalErrors"><strong [translate]="err.code"></strong></div>
    </div>

    <div *ngIf="!reservationInfo.orderSummary.free">
      <div class="page-header wMarginTop"><h2 translate="reservation-page.payment"></h2></div>

      <div *ngIf="paymentMethodsCount() > 1">
          <div class="btn-group btn-group-toggle payment-method-selector wMarginBottom">
            <label class="btn btn-outline-dark" [ngClass]="{'active': overviewForm.value.selectedPaymentMethod === 'CREDIT_CARD'}" *ngIf="event.activePaymentMethods['CREDIT_CARD']">
              <input type="radio" formControlName="selectedPaymentMethod" [value]="'CREDIT_CARD'"><fa-icon [icon]="['fas', 'credit-card']"></fa-icon> {{'reservation-page.credit-card'|translate}}
            </label>
            <label class="btn btn-outline-dark" [ngClass]="{'active': overviewForm.value.selectedPaymentMethod === 'PAYPAL'}" *ngIf="event.activePaymentMethods['PAYPAL']">
              <input type="radio" formControlName="selectedPaymentMethod" [value]="'PAYPAL'"><fa-icon [icon]="['fab', 'paypal']"></fa-icon> {{'reservation-page.paypal'|translate}}
            </label>
            <label class="btn btn-outline-dark" [ngClass]="{'active': overviewForm.value.selectedPaymentMethod === 'BANK_TRANSFER'}" *ngIf="event.activePaymentMethods['BANK_TRANSFER']">
              <input type="radio" formControlName="selectedPaymentMethod" [value]="'BANK_TRANSFER'"><fa-icon [icon]="['fas', 'exchange-alt']"></fa-icon> {{'reservation-page.offline'|translate}}
            </label>
            <label class="btn btn-outline-dark" [ngClass]="{'active': overviewForm.value.selectedPaymentMethod === 'ON_SITE'}" *ngIf="event.activePaymentMethods['ON_SITE']">
              <input type="radio" formControlName="selectedPaymentMethod" [value]="'ON_SITE'"><fa-icon [icon]="['fas', 'money-bill']"  size="sm"></fa-icon> {{'reservation-page.on-site'|translate}}
            </label>
          </div>
      </div>
      <div *ngIf="paymentMethodsCount() === 1">
          <h4 class="wMarginTop" [ngSwitch]="getSinglePaymentMethod()">
            <span *ngSwitchCase="'CREDIT_CARD'">
              <fa-icon [icon]="['fas', 'credit-card']"></fa-icon> {{'reservation-page.credit-card'|translate}}
            </span>
            <span *ngSwitchCase="'PAYPAL'">
                <fa-icon [icon]="['fab', 'paypal']"></fa-icon> {{'reservation-page.paypal'|translate}}
            </span>
            <span *ngSwitchCase="'BANK_TRANSFER'">
                <fa-icon [icon]="['fas', 'exchange-alt']"></fa-icon> {{'reservation-page.offline'|translate}}
            </span>
            <span *ngSwitchCase="'ON_SITE'">
                <fa-icon [icon]="['fas', 'money-bill']"></fa-icon> {{'reservation-page.on-site'|translate}}
            </span>
          </h4>
      </div>

      <div *ngIf="event.activePaymentMethods[overviewForm.value.selectedPaymentMethod]" >
          <app-offline-payment-proxy
            [proxy]="overviewForm.value.paymentMethod"
            [method]="overviewForm.value.selectedPaymentMethod"
            [parameters]="event.activePaymentMethods[overviewForm.value.selectedPaymentMethod].parameters"
            [overviewForm]="overviewForm"
            (paymentProvider)="registerCurrentPaymentProvider($event)">
          </app-offline-payment-proxy>
          <app-onsite-payment-proxy
            [proxy]="overviewForm.value.paymentMethod"
            [method]="overviewForm.value.selectedPaymentMethod"
            [parameters]="event.activePaymentMethods[overviewForm.value.selectedPaymentMethod].parameters"
            [overviewForm]="overviewForm"
            (paymentProvider)="registerCurrentPaymentProvider($event)">
          </app-onsite-payment-proxy>
          <app-stripe-payment-proxy
            [event]="event"
            [reservation]="reservationInfo"
            [proxy]="overviewForm.value.paymentMethod"
            [method]="overviewForm.value.selectedPaymentMethod"
            [parameters]="event.activePaymentMethods[overviewForm.value.selectedPaymentMethod].parameters"
            (paymentProvider)="registerCurrentPaymentProvider($event)">
          </app-stripe-payment-proxy>
          <app-paypal-payment-proxy
            [proxy]="overviewForm.value.paymentMethod"
            [method]="overviewForm.value.selectedPaymentMethod"
            [reservation]="reservationInfo"
            (paymentProvider)="registerCurrentPaymentProvider($event)">
          </app-paypal-payment-proxy>
      </div>
    </div>

    <div *ngIf="reservationInfo.orderSummary.free && event.captchaConfiguration.captchaForOfflinePaymentAndFree" class="wMarginTop wMarginBottom">
      <app-recaptcha [apiKey]="event.captchaConfiguration.recaptchaApiKey" (recaptchaResponse)="handleRecaptchaResponse($event)"></app-recaptcha>
    </div>

    <div class="custom-control custom-checkbox" *ngIf="event.privacyPolicyUrl">
        <input class="custom-control-input" id="privacyPolicyAccepted" formControlName="privacyPolicyAccepted" type="checkbox">{{' '}} <!-- ugly, see  https://github.com/angular/angular/issues/21049 -->
        <label for="privacyPolicyAccepted" class="custom-control-label">
          <span translate="reservation-page.privacy.prefix"></span>{{' '}}<a [attr.href]="event.privacyPolicyUrl" target="_blank" translate="reservation-page.privacy.link.text"></a><span translate="reservation-page.privacy.suffix"></span>
        </label>
    </div>
    <div class="custom-control custom-checkbox">
        <input class="custom-control-input" id="termsAndConditionsAccepted" formControlName="termAndConditionsAccepted" type="checkbox">
        <label class="custom-control-label" for="termsAndConditionsAccepted">
          {{' '}}<span translate="reservation-page.tc.prefix"></span>{{' '}}<a [attr.href]="event.termsAndConditionsUrl" target="_blank" translate="reservation-page.tc.link.text"></a><span translate="reservation-page.tc.suffix"></span>
        </label>
    </div>

    <div class="alert alert-info text-center" *ngIf="submitting">
      <strong ><span translate="reservation.payment-in-progress"></span><span class="dots"><span>.</span><span>.</span><span>.</span></span></strong>
    </div>

    <div class="row d-flex justify-content-between mobile-add-margin-bottom mt-4" *ngIf="!submitting">
      <div class="col-md-5 order-md-1 col-12">
        <button *ngIf="reservationInfo.orderSummary.free" type="submit" class="block-button btn btn-success" translate="reservation-page.continue" [disabled]="expired"></button>
        <button *ngIf="!reservationInfo.orderSummary.free" type="submit" class="block-button btn btn-success" [disabled]="expired || !selectedPaymentProvider || !acceptedPrivacyAndTermAndConditions">
          <ng-container *ngIf="!reservationInfo.tokenAcquired">
            {{'reservation-page.pay'| translate}} {{reservationInfo.orderSummary.totalPrice}} {{event.currency}}
          </ng-container>
          <ng-container *ngIf="reservationInfo.tokenAcquired">
            {{'reservation-page.confirm-button' | translate}}
          </ng-container>
        </button>
      </div>
      <div class="col-md-5 order-md-0 col-12 ">
        <button type="button" class="block-button btn btn-light" (click)="back()" translate="common.back" *ngIf="!reservationInfo.tokenAcquired"></button>
        <button type="button" class="block-button btn btn-light" (click)="clearToken()" translate="reservation-page-complete.cancel" *ngIf="reservationInfo.tokenAcquired"></button>
      </div>
    </div>
  </form>
</div>
